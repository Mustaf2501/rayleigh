<!DOCTYPE html>
<html>
<head>
  <title>Rayleigh: Search by multiple colors</title>
  <link href="/static/css/main.css" media="all" rel="stylesheet" type="text/css"/>
</head>
<body>
  <div id="content">
    <div id="colors">
      <h3>Possible colors</h3>
      {% include 'palette.html' %}
      
      <h3>Search algorithm</h3>
      <div id="sic_types"></div>

      <h3>Palette histogram</h3>
      <div id="palette_query"></div>

      <!--<form id="selected-colors-submit" method="get" action="/images">
        <input id="submitButton" type="submit" value="Search" onClick="getImages(); return false;" />
      </form>-->
    </div>
    <div id="images">
      <h3>Images that match the colors</h3>
    </div>
  </div>
  <script src="/static/js/jquery-1.8.3.js"></script>
  <script src="/static/js/sprintf-0.7-beta1.js"></script>
  <script>
    $(document).ready(function() {
      // console.log("The palette is:", $('#colors a').map(function(i,el) { return el.id; }));

      selected_colors = {};
      sic_type = '';

      // Get the types of SICs available and add links to them.
      $.getJSON('/sic_types',
        success=function(json_data) {
          sic_type = json_data[0];

          items = [];
          $.each(json_data, function(i, val) {
            items.push('<li><a href="#" onclick="sic_type=\'' + val + '\'; getImages(); return false;">' + val + '</a></li>');
          });
          $('#sic_types').html('<ul>' + items.join('') + '</ul>');
      });

      getSimilarImages = function(ind) {
        url = '/similar_to/' + sic_type + '/' + ind;
        $.getJSON(url, success=update_images);
      }

      var update_images = function(json_data) {
        // Display palette query histogram.
        $('#palette_query').html('<img width="100%" src="data:image/png;base64,'+json_data['pq_hist']+'" />');
        
        // Display image results.
        items = [];
        $.each(json_data['results'], function(i, val) {
          var id = val['id'];
          var filename = val['url'].replace('/Volumes/WD Data/', '/static/')
          
          var histogram_url = sprintf('/image_histogram/%s.png', id);
          var a_histogram = sprintf('<a href="%s">histogram</a>', histogram_url);

          var palette_url = sprintf('/palette_image/%s.png', id);
          var a_palette = sprintf('<a href="%s">palette</a>', palette_url);
          
          var onclick = sprintf('getSimilarImages(\'%s\'); return false;', id);
          var a_similar = sprintf('<a href="#" onclick="%s">similar</a>', onclick);
          
          var img = sprintf('<img src="%s" alt="%s" width="%s" height="%s" />',
            filename, val['distance'], val['width']/4, val['height']/4);
          var links = [a_histogram, a_palette, a_similar].join(' | ');
          items.push(sprintf('<div class="result">%s<br />%s</div>', img, links));
        });
        $('#images').html(items.join(''));
      }

      getImages = function(event) {
        $.getJSON(sprintf('/%s/search', sic_type),
          data={colors: Object.keys(selected_colors).join(',')},
          success=update_images);
      }

      var toggleSelected = function(event) {
        if (this.getAttribute('class') == 'selected') {
          delete(selected_colors[this.id]);
          this.setAttribute('class', '');
        } else {
          selected_colors[this.id] = 1;
          this.setAttribute('class', 'selected');
        }
        console.log("Selected colors:");
        console.log(selected_colors);

        getImages();
      };

      $('a').each(function(i,el) {
        el.onclick = toggleSelected;  
      });

      
    });
  </script>
</body>
</html>
